<!doctype html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="Author" content="greg Landrum">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <link rel="Stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <link rel="Stylesheet" href="https://cdn.datatables.net/1.10.16/css/dataTables.jqueryui.min.css" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/dataTables.jqueryui.min.js"></script>

</head>
<script src="./RDKit_minimal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/onnxjs/dist/onnx.min.js"></script>
<script>
    onRuntimeInitialized: initRDKitModule().then(function (instance) {
        RDKitModule = instance;
        callback("CC(=O)Oc1ccccc1C(=O)O");
        $('#table').DataTable({
            data: [],
            columns: [
                { title: "Target ChEMBL ID" },
                { title: "prediction" },
            ],
            "order": [[ 1, "desc" ]]
        });

    });
    function form_to_details(details) {
        var controls = ["addAtomIndices", "addBondIndices", "explicitMethyl", "addStereoAnnotation"];
        for (i in controls) {
            var control = controls[i];
            details[control] = document.getElementById(control).checked
        }
    }
    function draw_with_highlights(mol, details) {
        form_to_details(details);
        var tdetails = JSON.stringify(details)
        var canvas = document.getElementById("rdkit-canvas");
        mol.draw_to_canvas_with_highlights(canvas, tdetails);

    }
    function draw(mol) {
        var details = {};
        draw_with_highlights(mol, details);
        return;
        var canvas = document.getElementById("rdkit-canvas");
        mol.draw_to_canvas(canvas, -1, -1);
    }

    async function predict(text) {
        // create a session
        const myOnnxSession = new onnx.InferenceSession({ 'backendHint': 'cpu' });
        // load the ONNX model file
        myOnnxSession.loadModel("./chembl_28_multitask.onnx").then(() => {

            var mol = RDKitModule.get_mol(text);
            const fp = mol.get_morgan_fp(2, 1024);
            const descs = Float32Array.from(fp.split('').map(x => parseInt(x)));
            const tensor = new onnx.Tensor(descs, 'float32');

            myOnnxSession.run([tensor]).then((output) => {
                var preds = [];
                for (let [target, pred] of output.entries()) {
                    preds.push([target, pred.data[0]]);
                }
                $('#table').dataTable().fnClearTable();
                $('#table').dataTable().fnAddData(preds);
            });
        });
    }

    function callback(text) {
        var mol = RDKitModule.get_mol(text);
        if (mol.is_valid()) {
            draw(mol);
            predict(text);
        }
        mol.delete();

    }
    function sma_callback(text) {
        var qmol = RDKitModule.get_qmol(text);
        var mol = RDKitModule.get_mol(document.getElementById("smiles_input").value);
        if (mol.is_valid() && qmol.is_valid()) {
            var mdetails = mol.get_substruct_match(qmol);
            var match = JSON.parse(mdetails);
            if (match.atoms && match.atoms.length) draw_with_highlights(mol, match);
        }
        mol.delete();
        qmol.delete();
    }
    function option_changed(cb) {
        var smi = document.getElementById('smiles_input').value;
        var sma = document.getElementById('smarts_input').value;
        if (sma) {
            sma_callback(sma);
        } else {
            callback(smi, false);
        }
    }
    function abbreviation_option_changed(cb) {
        var smi = document.getElementById('smiles_input').value;
        var mol = RDKitModule.get_mol(smi);
        if (document.getElementById('useAbbreviations').checked) {
            var useLinkers = document.getElementById('useLinkers').checked;
            var maxCoverage = +(document.getElementById('maxCoverage').value);
            mol.condense_abbreviations(maxCoverage, useLinkers);
        }
        draw(mol);
    }

</script>

<body>
    <div class="container-fluid col-md-8">
        <h1>RDKit-JS ONNX runtime Multitask Target prediction demo</h1>
        <div id="molecule">
            <canvas id="rdkit-canvas" width="400" height="300" style="border:1px solid #000000;"></canvas>
            <br />
            <input type="checkbox" id="addAtomIndices" name="atomIndices" onclick="option_changed(this);">
            <label for="addAtomIndices">atomIndices</label>
            <input type="checkbox" id="addBondIndices" name="bondIndices" onclick="option_changed(this);">
            <label for="addBondIndices">bondIndices</label>
            <input type="checkbox" id="addStereoAnnotation" name="addStereoAnnotation" onclick="option_changed(this);">
            <label for="addStereoAnnotation">addStereoAnnotation</label>
            <br />
            <input type="checkbox" id="explicitMethyl" name="explicitMethyl" onclick="option_changed(this);" />
            <label for="explicitMethyl">explicitMethyl</label>

        </div>
        SMILES: <input id="smiles_input" type="text" value="CC(=O)Oc1ccccc1C(=O)O" onkeyup="callback(this.value,true)">
        SMARTS: <input id="smarts_input" type="text" value="" onkeyup="sma_callback(this.value)">
        <br />
        <br />
        <table id="table" class="display" width="100%"></table>
    </div>
</body>

</html>